--
-- Подготовка
--
CREATE EXTENSION extended_explain;
SET debug_parallel_query = off;
SET jit = off;
CREATE TABLE test_table(col integer); 
CREATE TABLE t1 (a int);
CREATE TABLE t2 (b int);
CREATE TABLE t3 (c int);
INSERT INTO test_table SELECT generate_series(1,1000);
INSERT INTO t1 SELECT generate_series(1, 100);
INSERT INTO t2 SELECT generate_series(1, 200);
INSERT INTO t3 SELECT generate_series(1, 50);
ANALYZE test_table, t1, t2, t3;
--
-- 1. Проверка параметра get_paths  
--
EXPLAIN
SELECT * FROM test_table;
                          QUERY PLAN                          
--------------------------------------------------------------
 Seq Scan on test_table  (cost=0.00..15.00 rows=1000 width=4)
(1 row)

SELECT 
	query_id, subquery_id, subquery_level, rel_id, path_id, path_type, child_paths,
	startup_cost, total_cost, rows, width, rel_name, rel_alias, indexoid, level,  
	add_path_result, displaced_by, cost_cmp, fuzz_factor, pathkeys_cmp, bms_cmp
	rows_cmp, parallel_safe_cmp
FROM ee.paths
ORDER BY path_id;
 query_id | subquery_id | subquery_level | rel_id | path_id | path_type | child_paths | startup_cost | total_cost | rows | width | rel_name | rel_alias | indexoid | level | add_path_result | displaced_by | cost_cmp | fuzz_factor | pathkeys_cmp | rows_cmp | parallel_safe_cmp 
----------+-------------+----------------+--------+---------+-----------+-------------+--------------+------------+------+-------+----------+-----------+----------+-------+-----------------+--------------+----------+-------------+--------------+----------+-------------------
(0 rows)

EXPLAIN (get_paths)
SELECT * FROM test_table;
                          QUERY PLAN                          
--------------------------------------------------------------
 Seq Scan on test_table  (cost=0.00..15.00 rows=1000 width=4)
(1 row)

SELECT 
	query_id, subquery_id, subquery_level, rel_id, path_id, path_type, child_paths,
	startup_cost, total_cost, rows, width, rel_name, rel_alias, indexoid, level,  
	add_path_result, displaced_by, cost_cmp, fuzz_factor, pathkeys_cmp, bms_cmp
	rows_cmp, parallel_safe_cmp
FROM ee.paths
ORDER BY path_id;
 query_id | subquery_id | subquery_level | rel_id | path_id | path_type | child_paths | startup_cost | total_cost | rows | width |  rel_name  | rel_alias | indexoid | level | add_path_result | displaced_by | cost_cmp | fuzz_factor | pathkeys_cmp | rows_cmp | parallel_safe_cmp 
----------+-------------+----------------+--------+---------+-----------+-------------+--------------+------------+------+-------+------------+-----------+----------+-------+-----------------+--------------+----------+-------------+--------------+----------+-------------------
        1 |           1 |              1 |      1 |       1 | SeqScan   |             |            0 |         15 | 1000 |     4 | test_table |           |          |     1 | saved           |              |          |             |              |          | 
        1 |           1 |              1 |      2 |       2 | SeqScan   |             |            0 |         15 | 1000 |     0 |            |           |          |     0 | saved           |              |          |             |              |          | 
(2 rows)

SELECT ee.clear();
NOTICE:  truncate cascades to table "paths"
 clear 
-------
 t
(1 row)

SELECT 
	query_id, subquery_id, subquery_level, rel_id, path_id, path_type, child_paths,
	startup_cost, total_cost, rows, width, rel_name, rel_alias, indexoid, level,  
	add_path_result, displaced_by, cost_cmp, fuzz_factor, pathkeys_cmp, bms_cmp
	rows_cmp, parallel_safe_cmp
FROM ee.paths
ORDER BY path_id;
 query_id | subquery_id | subquery_level | rel_id | path_id | path_type | child_paths | startup_cost | total_cost | rows | width | rel_name | rel_alias | indexoid | level | add_path_result | displaced_by | cost_cmp | fuzz_factor | pathkeys_cmp | rows_cmp | parallel_safe_cmp 
----------+-------------+----------------+--------+---------+-----------+-------------+--------------+------------+------+-------+----------+-----------+----------+-------+-----------------+--------------+----------+-------------+--------------+----------+-------------------
(0 rows)

--
-- 2. SeqScan
--
EXPLAIN (get_paths)
SELECT * FROM test_table;
                          QUERY PLAN                          
--------------------------------------------------------------
 Seq Scan on test_table  (cost=0.00..15.00 rows=1000 width=4)
(1 row)

SELECT 
	query_id, subquery_id, subquery_level, rel_id, path_id, path_type, child_paths,
	startup_cost, total_cost, rows, width, rel_name, rel_alias, indexoid, level,  
	add_path_result, displaced_by, cost_cmp, fuzz_factor, pathkeys_cmp, bms_cmp
	rows_cmp, parallel_safe_cmp
FROM ee.paths
ORDER BY path_id;
 query_id | subquery_id | subquery_level | rel_id | path_id | path_type | child_paths | startup_cost | total_cost | rows | width |  rel_name  | rel_alias | indexoid | level | add_path_result | displaced_by | cost_cmp | fuzz_factor | pathkeys_cmp | rows_cmp | parallel_safe_cmp 
----------+-------------+----------------+--------+---------+-----------+-------------+--------------+------------+------+-------+------------+-----------+----------+-------+-----------------+--------------+----------+-------------+--------------+----------+-------------------
        2 |           1 |              1 |      1 |       1 | SeqScan   |             |            0 |         15 | 1000 |     4 | test_table |           |          |     1 | saved           |              |          |             |              |          | 
        2 |           1 |              1 |      2 |       2 | SeqScan   |             |            0 |         15 | 1000 |     0 |            |           |          |     0 | saved           |              |          |             |              |          | 
(2 rows)

SELECT ee.clear();
NOTICE:  truncate cascades to table "paths"
 clear 
-------
 t
(1 row)

-- 
-- 3. IndexOnlyScan
--
CREATE INDEX ON test_table(col);
EXPLAIN (get_paths)
SELECT * FROM test_table WHERE col = 3;
                                        QUERY PLAN                                        
------------------------------------------------------------------------------------------
 Index Only Scan using test_table_col_idx on test_table  (cost=0.28..8.29 rows=1 width=4)
   Index Cond: (col = 3)
(2 rows)

SELECT 
	query_id, subquery_id, subquery_level, rel_id, path_id, path_type, child_paths,
	startup_cost, total_cost, rows, width, rel_name, rel_alias, level,  
	add_path_result, displaced_by, cost_cmp, fuzz_factor, pathkeys_cmp, bms_cmp
	rows_cmp, parallel_safe_cmp
FROM ee.paths
ORDER BY path_id;
 query_id | subquery_id | subquery_level | rel_id | path_id |   path_type    | child_paths |   startup_cost    |    total_cost     | rows | width |  rel_name  | rel_alias | level | add_path_result | displaced_by |        cost_cmp         | fuzz_factor | pathkeys_cmp | rows_cmp | parallel_safe_cmp 
----------+-------------+----------------+--------+---------+----------------+-------------+-------------------+-------------------+------+-------+------------+-----------+-------+-----------------+--------------+-------------------------+-------------+--------------+----------+-------------------
        3 |           1 |              1 |      1 |       1 | SeqScan        |             |                 0 |              17.5 |    1 |     4 | test_table |           |     1 | displaced       |            2 | total and startup worse |        1.01 | equal        | equal    | equal
        3 |           1 |              1 |      1 |       2 | IndexOnlyScan  |             |             0.275 |            8.2925 |    1 |     4 | test_table |           |     1 | saved           |              |                         |             |              |          | 
        3 |           1 |              1 |      1 |       3 | BitmapHeapScan |             | 4.282750000000001 | 8.295250000000001 |    1 |     4 | test_table |           |     1 | removed         |              |                         |             |              |          | 
        3 |           1 |              1 |      2 |       4 | IndexOnlyScan  |             |             0.275 |            8.2925 |    1 |     0 |            |           |     0 | saved           |              |                         |             |              |          | 
(4 rows)

SELECT ee.clear();
NOTICE:  truncate cascades to table "paths"
 clear 
-------
 t
(1 row)

DROP INDEX test_table_col_idx;
--
-- 4. CteScan
--
EXPLAIN (get_paths)
WITH cte AS MATERIALIZED
(
	SELECT * FROM test_table
)
SELECT * FROM cte;
                              QUERY PLAN                              
----------------------------------------------------------------------
 CTE Scan on cte  (cost=15.00..35.00 rows=1000 width=4)
   CTE cte
     ->  Seq Scan on test_table  (cost=0.00..15.00 rows=1000 width=4)
(3 rows)

SELECT 
	query_id, subquery_id, subquery_level, rel_id, path_id, path_type, child_paths,
	startup_cost, total_cost, rows, width, rel_name, rel_alias, indexoid, level,  
	add_path_result, displaced_by, cost_cmp, fuzz_factor, pathkeys_cmp, bms_cmp
	rows_cmp, parallel_safe_cmp
FROM ee.paths
ORDER BY path_id;
 query_id | subquery_id | subquery_level | rel_id | path_id | path_type | child_paths | startup_cost | total_cost | rows | width |  rel_name  | rel_alias | indexoid | level | add_path_result | displaced_by | cost_cmp | fuzz_factor | pathkeys_cmp | rows_cmp | parallel_safe_cmp 
----------+-------------+----------------+--------+---------+-----------+-------------+--------------+------------+------+-------+------------+-----------+----------+-------+-----------------+--------------+----------+-------------+--------------+----------+-------------------
        4 |           1 |              2 |      1 |       1 | SeqScan   |             |            0 |         15 | 1000 |     4 | test_table |           |          |     1 | saved           |              |          |             |              |          | 
        4 |           1 |              2 |      2 |       2 | SeqScan   |             |            0 |         15 | 1000 |     0 |            |           |          |     0 | saved           |              |          |             |              |          | 
        4 |           2 |              1 |      3 |       3 | CteScan   |             |            0 |         20 | 1000 |     4 |            |           |          |     1 | saved           |              |          |             |              |          | 
        4 |           2 |              1 |      4 |       4 | CteScan   |             |            0 |         20 | 1000 |     0 |            |           |          |     0 | saved           |              |          |             |              |          | 
(4 rows)

SELECT ee.clear();
NOTICE:  truncate cascades to table "paths"
 clear 
-------
 t
(1 row)

--
-- 5. HashJoin
--
EXPLAIN (get_paths)
SELECT * FROM t1 JOIN t2 ON t1.a = t2.b;
                           QUERY PLAN                           
----------------------------------------------------------------
 Hash Join  (cost=3.25..8.00 rows=100 width=8)
   Hash Cond: (t2.b = t1.a)
   ->  Seq Scan on t2  (cost=0.00..3.00 rows=200 width=4)
   ->  Hash  (cost=2.00..2.00 rows=100 width=4)
         ->  Seq Scan on t1  (cost=0.00..2.00 rows=100 width=4)
(5 rows)

SELECT 
	query_id, subquery_id, subquery_level, rel_id, path_id, path_type, child_paths,
	startup_cost, total_cost, rows, width, rel_name, rel_alias, indexoid, level,  
	add_path_result, displaced_by, cost_cmp, fuzz_factor, pathkeys_cmp, bms_cmp
	rows_cmp, parallel_safe_cmp
FROM ee.paths
ORDER BY path_id;
 query_id | subquery_id | subquery_level | rel_id | path_id | path_type | child_paths |    startup_cost    |     total_cost     | rows | width | rel_name | rel_alias | indexoid | level | add_path_result | displaced_by |        cost_cmp         | fuzz_factor | pathkeys_cmp | rows_cmp | parallel_safe_cmp 
----------+-------------+----------------+--------+---------+-----------+-------------+--------------------+--------------------+------+-------+----------+-----------+----------+-------+-----------------+--------------+-------------------------+-------------+--------------+----------+-------------------
        5 |           1 |              1 |      1 |       1 | SeqScan   |             |                  0 |                  2 |  100 |     4 | t1       |           |          |     1 | saved           |              |                         |             |              |          | 
        5 |           1 |              1 |      2 |       2 | SeqScan   |             |                  0 |                  3 |  200 |     4 | t2       |           |          |     1 | saved           |              |                         |             |              |          | 
        5 |           1 |              1 |      3 |       3 | MergeJoin | {1,2}       | 15.965784284662092 | 17.965784284662092 |  100 |     8 |          |           |          |     2 | displaced       |            4 | total and startup worse |        1.01 | equal        | equal    | equal
        5 |           1 |              1 |      3 |       4 | HashJoin  | {1,2}       |                5.5 |              8.875 |  100 |     8 |          |           |          |     2 | displaced       |            5 | total and startup worse |        1.01 | equal        | equal    | equal
        5 |           1 |              1 |      3 |       5 | HashJoin  | {2,1}       |               3.25 |                  8 |  100 |     8 |          |           |          |     2 | saved           |              |                         |             |              |          | 
        5 |           1 |              1 |      4 |       6 | HashJoin  | {2,1}       |               3.25 |                  8 |  100 |     0 |          |           |          |     0 | saved           |              |                         |             |              |          | 
(6 rows)

SELECT ee.clear();
NOTICE:  truncate cascades to table "paths"
 clear 
-------
 t
(1 row)

--
-- 6. Агрегаты (Agg)
--
EXPLAIN (get_paths)
SELECT COUNT(*) FROM t1;
                        QUERY PLAN                        
----------------------------------------------------------
 Aggregate  (cost=2.25..2.26 rows=1 width=8)
   ->  Seq Scan on t1  (cost=0.00..2.00 rows=100 width=0)
(2 rows)

SELECT 
	query_id, subquery_id, subquery_level, rel_id, path_id, path_type, child_paths,
	startup_cost, total_cost, rows, width, rel_name, rel_alias, indexoid, level,  
	add_path_result, displaced_by, cost_cmp, fuzz_factor, pathkeys_cmp, bms_cmp
	rows_cmp, parallel_safe_cmp
FROM ee.paths
ORDER BY path_id;
 query_id | subquery_id | subquery_level | rel_id | path_id | path_type | child_paths | startup_cost | total_cost | rows | width | rel_name | rel_alias | indexoid | level | add_path_result | displaced_by | cost_cmp | fuzz_factor | pathkeys_cmp | rows_cmp | parallel_safe_cmp 
----------+-------------+----------------+--------+---------+-----------+-------------+--------------+------------+------+-------+----------+-----------+----------+-------+-----------------+--------------+----------+-------------+--------------+----------+-------------------
        6 |           1 |              1 |      1 |       1 | SeqScan   |             |            0 |          2 |  100 |     0 | t1       |           |          |     1 | saved           |              |          |             |              |          | 
        6 |           1 |              1 |      2 |       2 | Agg       | {1}         |         2.25 |       2.26 |    1 |     8 |          |           |          |     0 | saved           |              |          |             |              |          | 
        6 |           1 |              1 |      3 |       3 | Agg       | {1}         |         2.25 |       2.26 |    1 |     0 |          |           |          |     0 | saved           |              |          |             |              |          | 
(3 rows)

SELECT ee.clear();
NOTICE:  truncate cascades to table "paths"
 clear 
-------
 t
(1 row)

--
-- 7. Сортировка (Sort)
--
EXPLAIN (get_paths)
SELECT * FROM t1 ORDER BY a;
                        QUERY PLAN                        
----------------------------------------------------------
 Sort  (cost=5.32..5.57 rows=100 width=4)
   Sort Key: a
   ->  Seq Scan on t1  (cost=0.00..2.00 rows=100 width=4)
(3 rows)

SELECT 
	query_id, subquery_id, subquery_level, rel_id, path_id, path_type, child_paths,
	startup_cost, total_cost, rows, width, rel_name, rel_alias, indexoid, level,  
	add_path_result, displaced_by, cost_cmp, fuzz_factor, pathkeys_cmp, bms_cmp
	rows_cmp, parallel_safe_cmp
FROM ee.paths
ORDER BY path_id;
 query_id | subquery_id | subquery_level | rel_id | path_id | path_type | child_paths |   startup_cost    |    total_cost     | rows | width | rel_name | rel_alias | indexoid | level | add_path_result | displaced_by | cost_cmp | fuzz_factor | pathkeys_cmp | rows_cmp | parallel_safe_cmp 
----------+-------------+----------------+--------+---------+-----------+-------------+-------------------+-------------------+------+-------+----------+-----------+----------+-------+-----------------+--------------+----------+-------------+--------------+----------+-------------------
        7 |           1 |              1 |      1 |       1 | SeqScan   |             |                 0 |                 2 |  100 |     4 | t1       |           |          |     1 | saved           |              |          |             |              |          | 
        7 |           1 |              1 |      2 |       2 | Sort      | {1}         | 5.321928094887364 | 5.571928094887364 |  100 |     0 |          |           |          |     0 | saved           |              |          |             |              |          | 
        7 |           1 |              1 |      3 |       3 | Sort      | {1}         | 5.321928094887364 | 5.571928094887364 |  100 |     0 |          |           |          |     0 | saved           |              |          |             |              |          | 
(3 rows)

SELECT ee.clear();
NOTICE:  truncate cascades to table "paths"
 clear 
-------
 t
(1 row)

--
-- 8. LIMIT
--
EXPLAIN (get_paths)
SELECT * FROM t1 LIMIT 5;
                        QUERY PLAN                        
----------------------------------------------------------
 Limit  (cost=0.00..0.10 rows=5 width=4)
   ->  Seq Scan on t1  (cost=0.00..2.00 rows=100 width=4)
(2 rows)

SELECT 
	query_id, subquery_id, subquery_level, rel_id, path_id, path_type, child_paths,
	startup_cost, total_cost, rows, width, rel_name, rel_alias, indexoid, level,  
	add_path_result, displaced_by, cost_cmp, fuzz_factor, pathkeys_cmp, bms_cmp
	rows_cmp, parallel_safe_cmp
FROM ee.paths
ORDER BY path_id;
 query_id | subquery_id | subquery_level | rel_id | path_id | path_type | child_paths | startup_cost | total_cost | rows | width | rel_name | rel_alias | indexoid | level | add_path_result | displaced_by | cost_cmp | fuzz_factor | pathkeys_cmp | rows_cmp | parallel_safe_cmp 
----------+-------------+----------------+--------+---------+-----------+-------------+--------------+------------+------+-------+----------+-----------+----------+-------+-----------------+--------------+----------+-------------+--------------+----------+-------------------
        8 |           1 |              1 |      1 |       1 | SeqScan   |             |            0 |          2 |  100 |     4 | t1       |           |          |     1 | saved           |              |          |             |              |          | 
        8 |           1 |              1 |      2 |       2 | Limit     | {1}         |            0 |        0.1 |    5 |     0 |          |           |          |     0 | saved           |              |          |             |              |          | 
(2 rows)

SELECT ee.clear();
NOTICE:  truncate cascades to table "paths"
 clear 
-------
 t
(1 row)

--
-- 9. Append
--
EXPLAIN (get_paths)
WITH cte AS NOT MATERIALIZED
(
    SELECT * FROM t1
)
SELECT * FROM cte
UNION ALL
SELECT * FROM cte;
                          QUERY PLAN                           
---------------------------------------------------------------
 Append  (cost=0.00..5.00 rows=200 width=4)
   ->  Seq Scan on t1  (cost=0.00..2.00 rows=100 width=4)
   ->  Seq Scan on t1 t1_1  (cost=0.00..2.00 rows=100 width=4)
(3 rows)

SELECT 
	query_id, subquery_id, subquery_level, rel_id, path_id, path_type, child_paths,
	startup_cost, total_cost, rows, width, rel_name, rel_alias, indexoid, level,  
	add_path_result, displaced_by, cost_cmp, fuzz_factor, pathkeys_cmp, bms_cmp
	rows_cmp, parallel_safe_cmp
FROM ee.paths
ORDER BY path_id;
 query_id | subquery_id | subquery_level | rel_id | path_id | path_type | child_paths | startup_cost |     total_cost     | rows | width | rel_name | rel_alias  | indexoid | level | add_path_result | displaced_by | cost_cmp | fuzz_factor | pathkeys_cmp | rows_cmp | parallel_safe_cmp 
----------+-------------+----------------+--------+---------+-----------+-------------+--------------+--------------------+------+-------+----------+------------+----------+-------+-----------------+--------------+----------+-------------+--------------+----------+-------------------
        9 |           1 |              1 |      1 |       1 | SeqScan   |             |            0 |                  2 |  100 |     4 | t1       |            |          |     1 | saved           |              |          |             |              |          | 
        9 |           1 |              1 |      2 |       2 | SeqScan   |             |            0 |                  2 |  100 |     4 | t1       |            |          |     1 | saved           |              |          |             |              |          | 
        9 |           1 |              1 |      3 |       3 | Append    |             |            0 |                  5 |  200 |     4 |          | *SELECT* 1 |          |     1 | saved           |              |          |             |              |          | 
        9 |           1 |              1 |      3 |       4 | Gather    | {5}         |         1000 | 1023.5964705882353 |  200 |     4 |          | *SELECT* 1 |          |     1 | removed         |              |          |             |              |          | 
        9 |           1 |              1 |      3 |       5 | Append    |             |            0 | 3.5964705882352943 |   84 |     4 |          | *SELECT* 1 |          |     1 | saved           |              |          |             |              |          | 
        9 |           1 |              1 |      4 |       6 | Append    |             |            0 |                  5 |  200 |     0 |          |            |          |     0 | saved           |              |          |             |              |          | 
(6 rows)

SELECT ee.clear();
NOTICE:  truncate cascades to table "paths"
 clear 
-------
 t
(1 row)

--
-- Очистка
--
DROP TABLE test_table, t1, t2, t3;

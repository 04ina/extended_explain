From 7be8eddf6e8842b766dd0bb29a7d13a827d36548 Mon Sep 17 00:00:00 2001
From: 04ina <o4inaDev@yandex.ru>
Date: Thu, 29 Jan 2026 07:56:54 +0700
Subject: [PATCH] Add add_path_hook functionality

---
 src/backend/optimizer/util/pathnode.c | 5 +++++
 src/include/optimizer/pathnode.h      | 4 ++++
 2 files changed, 9 insertions(+)

diff --git a/src/backend/optimizer/util/pathnode.c b/src/backend/optimizer/util/pathnode.c
index b0da28150d3..82723111824 100644
--- a/src/backend/optimizer/util/pathnode.c
+++ b/src/backend/optimizer/util/pathnode.c
@@ -46,6 +46,8 @@ typedef enum
  */
 #define STD_FUZZ_FACTOR 1.01
 
+add_path_hook_type add_path_hook = NULL;
+
 static int	append_total_cost_compare(const ListCell *a, const ListCell *b);
 static int	append_startup_cost_compare(const ListCell *a, const ListCell *b);
 static List *reparameterize_pathlist_by_child(PlannerInfo *root,
@@ -469,6 +471,9 @@ add_path(RelOptInfo *parent_rel, Path *new_path)
 	 */
 	CHECK_FOR_INTERRUPTS();
 
+	if (add_path_hook)
+		(*add_path_hook) (parent_rel, new_path);
+
 	/* Pretend parameterized paths have no pathkeys, per comment above */
 	new_path_pathkeys = new_path->param_info ? NIL : new_path->pathkeys;
 
diff --git a/src/include/optimizer/pathnode.h b/src/include/optimizer/pathnode.h
index 763cd25bb3c..9d010d5aa43 100644
--- a/src/include/optimizer/pathnode.h
+++ b/src/include/optimizer/pathnode.h
@@ -17,6 +17,10 @@
 #include "nodes/bitmapset.h"
 #include "nodes/pathnodes.h"
 
+/* Hook for plugins to get control in add_path_hook() */
+typedef void (*add_path_hook_type)(RelOptInfo *parent_rel,
+								   Path *new_path);
+extern PGDLLIMPORT add_path_hook_type add_path_hook;
 
 /*
  * prototypes for pathnode.c
-- 
2.34.1


From 41f82b4c9f56b06d181d95f5a9328cf4d8a816cf Mon Sep 17 00:00:00 2001
From: 04ina <o4inaDev@yandex.ru>
Date: Thu, 29 Jan 2026 06:43:32 +0700
Subject: [PATCH] Add add_path_hook functionality

---
 src/backend/optimizer/util/pathnode.c | 5 +++++
 src/include/optimizer/pathnode.h      | 4 ++++
 2 files changed, 9 insertions(+)

diff --git a/src/backend/optimizer/util/pathnode.c b/src/backend/optimizer/util/pathnode.c
index e8d8a53706..339f8880a2 100644
--- a/src/backend/optimizer/util/pathnode.c
+++ b/src/backend/optimizer/util/pathnode.c
@@ -49,6 +49,8 @@ typedef enum
  */
 #define STD_FUZZ_FACTOR 1.01
 
+add_path_hook_type add_path_hook = NULL;
+
 static List *translate_sub_tlist(List *tlist, int relid);
 static int	append_total_cost_compare(const ListCell *a, const ListCell *b);
 static int	append_startup_cost_compare(const ListCell *a, const ListCell *b);
@@ -474,6 +476,9 @@ add_path(RelOptInfo *parent_rel, Path *new_path)
 	 */
 	CHECK_FOR_INTERRUPTS();
 
+	if (add_path_hook)
+		(*add_path_hook) (parent_rel, new_path);
+
 	/* Pretend parameterized paths have no pathkeys, per comment above */
 	new_path_pathkeys = new_path->param_info ? NIL : new_path->pathkeys;
 
diff --git a/src/include/optimizer/pathnode.h b/src/include/optimizer/pathnode.h
index 60dcdb77e4..f4ec1e8a42 100644
--- a/src/include/optimizer/pathnode.h
+++ b/src/include/optimizer/pathnode.h
@@ -17,6 +17,10 @@
 #include "nodes/bitmapset.h"
 #include "nodes/pathnodes.h"
 
+/* Hook for plugins to get control in add_path_hook() */
+typedef void (*add_path_hook_type)(RelOptInfo *parent_rel,
+								   Path *new_path);
+extern PGDLLIMPORT add_path_hook_type add_path_hook;
 
 /*
  * prototypes for pathnode.c
-- 
2.34.1

